---
export const prerender = false;

import Layout from '../layouts/MemberLayout.astro';
import { supabaseAdmin } from '../lib/supabaseAdmin';

const pageTitle = "Dashboard";

// Get the access token from cookies
const accessToken = Astro.cookies.get('sb-access-token')?.value;

let user = null;
if (accessToken) {
  const { data, error } = await supabaseAdmin.auth.getUser(accessToken);
  if (error) console.error('Supabase getUser error:', error.message);
  user = data.user;
}

if (!user) {
  throw Astro.redirect('/login');
}

// Fetch roles from DB (user_roles â†’ roles(name))
type RoleNameObj = { name: string };
type AdminRow = { roles: RoleNameObj[] | RoleNameObj | null };

const { data: myRoleRows, error: myRoleErr } = await supabaseAdmin
  .from('user_roles')
  .select('roles(name)')
  .eq('user_id', user.id);

if (myRoleErr) {
  console.error('load my roles error:', myRoleErr.message);
}

// Normalize into a simple string[]
const roleNames: string[] = (myRoleRows ?? []).flatMap((r: AdminRow) => {
  const rs = r.roles;
  if (Array.isArray(rs)) return rs.map(x => x?.name).filter(Boolean) as string[];
  if (rs && typeof rs === 'object' && 'name' in rs && rs.name) return [String(rs.name)];
  return [];
});

const primaryRole = roleNames[0] || 'basic';
const isAdmin = roleNames.includes('administrator');


// Redirect Administrators to the Admin Dashboard
// For testing, to see the regular dashboard, you need to login with a basic account
if (primaryRole == 'administrator') {
  return Astro.redirect('/admin');
}

---

<Layout pageTitle={pageTitle}>
    <h1 class="text-1xl font-bold mb-4">Welcome, {user.email}</h1>

    <div class="grid grid-cols-12 my-5" role="main">

    <section class="col-span-9">
      <h2 class="text-2xl font-bold">Tools</h2>
      <p>You are currently not subscribed to any tools.</p>
    </section>

    <aside class="col-span-3 bg-gray-300 text-black p-4 rounded">
      <div class="mb-4">
        <div class="text-sm opacity-80">Primary Role</div>
        <div class="text-lg">{primaryRole}</div>
      </div>

      <div class="mb-6">
        <div class="text-sm opacity-80 mb-1">All Roles</div>
        {roleNames.length > 0 ? (
          <div class="flex flex-wrap gap-2">
            {roleNames.map((r) => (
              <span class="px-2 py-1 rounded border border-gray-700 text-sm acornblue">{r}</span>
            ))}
          </div>
        ) : (
          <div class="text-gray-400">none</div>
        )}
      </div>
    </aside>
    </div>
</Layout>
