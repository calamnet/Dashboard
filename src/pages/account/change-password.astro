---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import { supabaseAdmin } from '../../lib/supabaseAdmin';

const pageTitle = "Change Password";

// Auth (same pattern as your dashboard)
const accessToken = Astro.cookies.get('sb-access-token')?.value;
let user = null;
if (accessToken) {
  const { data, error } = await supabaseAdmin.auth.getUser(accessToken);
  if (error) console.error('Supabase getUser error:', error.message);
  user = data.user;
}
if (!user) {
  throw Astro.redirect('/login');
}

// Read any error code from the URL
const err = Astro.url.searchParams.get('err');
const messages: Record<string, string> = {
  missing: "Please fill out all fields.",
  short: "New password must be at least 8 characters.",
  nomatch: "New password and confirmation do not match.",
  badpass: "Current password is incorrect.",
  update: "Failed to update password. Please try again.",
  server: "Unexpected server error. Please try again.",
};
const alertText = err ? (messages[err] ?? "Something went wrong.") : "";
---

<Layout pageTitle={pageTitle}>
  <section class="max-w-lg mx-auto bg-gray-900 text-white p-6 rounded-lg shadow-lg">
    <h1 class="text-2xl font-bold mb-2">{pageTitle}</h1>
    <p class="text-sm text-gray-300 mb-6">Enter your current password and choose a new one.</p>

    {alertText && (
      <div class="mt-3 rounded-md border border-red-300 bg-red-50 text-red-700 px-3 py-2 text-sm">
        {alertText}
      </div>
    )}

    <form class="space-y-4" method="post" action="/api/change-password">
      <div>
        <label class="block text-sm font-medium mb-1" for="currentPassword">Current password</label>
        <input
          id="currentPassword"
          name="currentPassword"
          type="password"
          required
          autocomplete="current-password"
          class="w-full rounded-md bg-gray-800 border border-gray-700 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
      </div>

      <div>
        <label class="block text-sm font-medium mb-1" for="newPassword">New password</label>
        <input
          id="newPassword"
          name="newPassword"
          type="password"
          required
          minlength="8"
          autocomplete="new-password"
          class="w-full rounded-md bg-gray-800 border border-gray-700 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
        <p class="text-xs text-gray-400 mt-1">Use at least 8 characters.</p>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1" for="confirmPassword">Confirm new password</label>
        <input
          id="confirmPassword"
          name="confirmPassword"
          type="password"
          required
          autocomplete="new-password"
          class="w-full rounded-md bg-gray-800 border border-gray-700 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
      </div>

      <button
        type="submit"
        class="w-full rounded-md bg-blue-600 text-white py-2 font-medium hover:bg-blue-700"
      >
        Change password
      </button>
    </form>
  </section>
</Layout>
