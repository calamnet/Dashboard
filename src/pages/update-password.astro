---
export const prerender = false;
import Layout from '../layouts/Layout.astro';

const pageTitle = "Set a New Password";
const err = Astro.url.searchParams.get("err");
const messages: Record<string, string> = {
  norecovery: "This reset link is missing the recovery token. Please request a new link.",
  invalid: "This reset link is invalid or expired. Please request a new link.",
  missing: "Please fill out all fields.",
  short: "New password must be at least 8 characters.",
  nomatch: "New password and confirmation do not match.",
  update: "Failed to update password. Please try again.",
  server: "Unexpected server error. Please try again.",
};
---

<Layout pageTitle={pageTitle}>
  <div class="max-w-md mx-auto bg-gray-900 text-white p-6 rounded-lg shadow-lg">
    <h1 class="text-2xl font-bold mb-4">{pageTitle}</h1>
    <p class="text-sm text-gray-300 mb-6">Enter your new password below.</p>

    {err && (
      <div class="mb-4 rounded-md border border-red-600 bg-red-900/30 text-red-300 px-3 py-2 text-sm">
        {messages[err] ?? "Something went wrong. Please try again."}
      </div>
    )}

    <form id="pwForm" class="flex flex-col gap-4" method="post" action="/api/complete-reset">
      <!-- hidden input populated from the URL hash -->
      <input type="hidden" id="access_token" name="access_token" />

      <input
        id="newPassword"
        name="newPassword"
        type="password"
        placeholder="New password"
        minlength="8"
        required
        class="border border-gray-300 p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black"
        autocomplete="new-password"
      />
      <input
        id="confirmPassword"
        name="confirmPassword"
        type="password"
        placeholder="Confirm new password"
        required
        class="border border-gray-300 p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black"
        autocomplete="new-password"
      />
      <button class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-700">
        Update password
      </button>
    </form>

    <p class="mt-4 text-sm">
      Already changed it? <a href="/login" class="text-white underline">Back to login</a>
    </p>
  </div>

  <script type="module">
    // Extract access_token from the URL hash and put it into the hidden field
    try {
      const hash = new URLSearchParams(location.hash.slice(1)); // remove '#'
      const at = hash.get("access_token");
      if (at) {
        document.getElementById("access_token").value = at;
        // Clean the URL hash to avoid resubmission issues
        history.replaceState({}, "", location.pathname + location.search);
      }
    } catch (e) {
      console.error("Failed to parse recovery token:", e);
    }
  </script>
</Layout>