---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import { supabaseAdmin } from '../lib/supabaseAdmin';

const pageTitle = "Admin Dashboard";

// Get the access token from cookies
const accessToken = Astro.cookies.get('sb-access-token')?.value;

let user = null;
if (accessToken) {
  const { data, error } = await supabaseAdmin.auth.getUser(accessToken);
  if (error) console.error('Supabase getUser error:', error.message);
  user = data.user;
}

if (!user) {
  throw Astro.redirect('/login');
}

// Check if user is admin
const roles = user?.user_metadata?.roles || [];
const isAdmin = roles.includes('administrator');

if (!isAdmin) {
  throw Astro.redirect('/dashboard');
}

// List all users
const { data: usersData, error: usersError } = await supabaseAdmin.auth.admin.listUsers();
const usersArray = usersData?.users || [];
---

<Layout pageTitle={pageTitle}>
  <div class="max-w-4xl mx-auto bg-gray-900 text-white p-6 rounded-lg shadow-lg">
    <h1 class="text-2xl font-bold mb-4">Admin Dashboard</h1>
    <p class="mb-4">Logged in as: {user.email}</p>

    {usersError && <p class="text-red-400">Error loading users: {usersError.message}</p>}

    <table class="w-full text-left border-collapse mb-4">
      <thead>
        <tr>
          <th class="border-b border-gray-600 p-2">Email</th>
          <th class="border-b border-gray-600 p-2">Roles</th>
          <th class="border-b border-gray-600 p-2">Actions</th>
        </tr>
      </thead>
      <tbody>
        {usersArray.map(u => {
          const userRoles = u.user_metadata?.roles || [];
          return (
            <tr>
              <td class="border-b border-gray-600 p-2">{u.email}</td>
              <td class="border-b border-gray-600 p-2">{JSON.stringify(userRoles)}</td>
              <td class="border-b border-gray-600 p-2">
                <form method="POST" action="/api/update-roles">
                  <input type="hidden" name="userId" value={u.id} />
                  <input
                    type="text"
                    name="roles"
                    class="bg-gray-800 text-white p-1 rounded mr-2 w-40"
                    value={userRoles.join(', ')}
                  />
                  <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded">
                    Update
                  </button>
                </form>
              </td>
            </tr>
          );
        })}
      </tbody>
    </table>

    <a href="/api/logout" class="text-blue-400 hover:underline">Log Out</a>
  </div>
</Layout>
